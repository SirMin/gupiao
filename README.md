选股策略说明书（Markdown 版）

数据源：Baostock
回测框架：Backtrader（策略引擎）
打分引擎：自定义 ScoreEngine（StockScore + 自定义因子）
目标：每日/每周输出候选股票列表（按综合得分排序），严格优先主策略，找不到才逐级回退

⸻

1. 策略目标与总体思路
	•	目标：在 A 股中抓取“温和上升且资金支撑、基本面相对稳健”的中短线候选股，供人工或量化择时买入参考。
	•	总体思路：先用策略引擎（规则）做硬筛选（趋势 + 均线 + 换手 + 市值 + 价格 + 板块/大盘），通过分级回退保证每日不空仓；对通过筛选的股票使用**评分引擎（ScoreEngine）**打分排序（财务 + 资金面 + 波动稳定性 + 价格位置等），输出 Top N。

⸻

2. 数据与频率
	•	日线行情：Baostock
	•	运行频率：每日收盘后 1 次（也可改为每周）

⸻

3. 核心筛选（主策略，必须满足）

3.1 基本过滤
	•	当前收盘价 < 100 元
	•	总市值在 [50亿, 500亿]（可配置）

3.2 趋势条件（主）
	•	连续上涨天数：默认 3（可配置为 3–5）且每天涨幅 ≥ 市值分层对应阈值（见下）
	•	3 日累计涨幅：≤ 市值分层对应上限（见下）

3.3 均线（强趋势确认）
	•	当日收盘价 > 5 日均线
	•	且 MA5 > MA10 > MA20（多头排列）

3.4 换手率与累计换手率（三方案，至少满足其中一个）

换手率与市值联动，避免阈值错位

	•	方案一：分层区间法（静态阈值）
	•	小盘（<100 亿）：日换手率 5%–15%，3 日累计 ≤ 30%
	•	中盘（100–500 亿）：日换手率 2%–8%，3 日累计 ≤ 15%
	•	大盘（>500 亿）：日换手率 1%–3%，3 日累计 ≤ 8%
	•	方案二：相对换手率法（相对于历史）
	•	单日换手率 > 60 日均换手率 × 1.5 且 < ×3
	•	3 日累计换手率 ≤ 3 × 60 日均换手率 × k（k=1.5~2，可调）
	•	方案三：活跃度指标法
	•	单日活跃度 = 换手率 × log(市值)
	•	3 日累计活跃度 = 3 日累计换手率 × log(市值)
	•	设定区间 A <= 活跃度 <= B（需回测确定，例如单日 5–50，累计 20–80）

3.5 板块 / 大盘过滤（辅）
	•	大盘：例如沪深300 近 10 日涨幅 > 0 且在 20 日均线以上
	•	板块：所属板块 近 10 日涨幅 > 大盘、并且板块 5/10/20 日均线多头、近 3 日资金净流入 > 0
	•	（若想放宽，可把板块/大盘作为排序因子而非硬性条件）

⸻

4. 分级回退机制（只在主策略无候选时触发）

执行顺序：主策略 → 回退1 → 回退2 → 兜底，一旦某级找到 ≥1 支股票即停止回退并返回该级结果。

回退1（轻微放宽）
	•	连续上涨天数降为 2
	•	均线条件放宽为 MA5 > MA10（不强制 MA20）
	•	换手率：允许满足 方案1 或 方案2（而非更严格的交集）
	•	累计涨幅上限适当放宽（例如 +20%）

回退2（再放宽）
	•	不强制连续上涨，改为 当日收盘 > MA10 且 当日上涨
	•	换手率只需高于行业/板块中位数或满足方案2 的更宽松版本

兜底（强放宽，保证非空）
	•	仅要求：市值范围 + 股价 < 100
	•	对候选按评分 (财务 + 资金 + 稳定性 + 价格位置) 排序并输出 Top N

⸻

5. 评分引擎（ScoreEngine）——可配置、可扩展

评分引擎把若干独立因子按权重合成最终总分；每个因子是独立模块（继承统一接口），可随时增删、调权重。

5.1 建议的评分因子（示例）
	•	财务因子（FinancialFactor）
	•	ROE、营收增长、净利润同比、负债率、自由现金流
	•	建议权重：~0.25–0.35
	•	资金面因子（FundFlowFactor）
	•	近 3 日主力净买入占流通市值比（%）、量比、成交额比
	•	建议权重：~0.2–0.3
	•	稳定性因子（StabilityFactor）
	•	最近 3 日：日振幅、收盘价标准差、是否有极端单日涨跌（>5%）
	•	规则：波动小得分高；极端波动扣分
	•	建议权重：~0.2–0.3
	•	价格位置因子（PricePositionFactor）
	•	当前价在过去 T（默认 252）交易日区间的位置（低位得高分）
	•	建议权重：~0.1–0.2
	•	StockScore / 其它多因子（可选）
	•	例如成长/价值/动量综合（直接接入已有开源 StockScore 项目模块）
	•	建议权重：可选（例如 0.1）

5.2 权重与归一化
	•	每个因子输出 0–X 分（或 0–1），引擎对因子值归一化后按权重加权求和得到 total_score
	•	权重由用户配置（运行时可调整），建议做参数扫描/回测优化权重组合

⸻

6. 输出格式（每只候选股）

建议返回结构（DataFrame / CSV）包含字段：
	•	code, name
	•	date（筛选日期）
	•	total_score（综合分）
	•	各因子得分（fin_score, fund_score, stab_score, price_pos_score, stockscore）
	•	技术信号概览（consecutive_days, 3d_return, MA5/10/20状态）
	•	换手率 & 累计换手率信息（近 1/3 日）
	•	market_value, close, volume, turnover
	•	strategy_level（主策略 / 回退1 / 回退2 / 兜底）

⸻

7. 卖出 / 风控规则（建议）
	•	止盈：累计涨幅 ≥ 10% 卖出 50%；≥ 20% 卖出全部
	•	止损：回撤 ≥ 5% 或 股价跌破 5 日均线 → 全部止损
	•	时间止盈：持仓超过 10 个交易日仍未达目标 → 考虑平仓
	•	仓位管理：单股仓位不超过总资金的 x%（x 视账户规模、风险偏好设定）

⸻

8. 回测与验证建议
	•	回测场景：牛市 / 熊市 / 横盘 三类分开回测，并做跨周期稳定性验证
	•	指标关注：年化收益、最大回撤、胜率、年化夏普、最大回撤期间的回撤恢复期
	•	参数扫描：连续上涨天数、换手率阈值、活跃度区间、评分权重做网格搜索或贝叶斯优化
	•	样本外测试：用不同时间段或不同板块验证模型稳健性

⸻

9. 实现建议（工程化）
	•	模块化：
	•	data_loader Baostock 
	•	preprocessor（合并、补全、计算指标）
	•	strategy_engine（规则因子、回退逻辑）
	•	score_engine（因子类 + 权重配置）
	•	runner（每日执行、排序、输出）
	•	reporter（CSV/Excel 输出 + 可视化）
	•	配置化：阈值和权重写入 yaml/json 配置文件，便于回测与实盘切换
	•	日志与监控：记录每日候选池、回退触发记录、因子分布等以便诊断
	•	单元测试：对每个因子、回退路径、数据处理编写单元测试

⸻

10. 默认参数（可调，供快速启动）
	•	连续上涨天数（主）：3
	•	连续上涨天数（回退1/2）：2、1
	•	单日涨幅阈值（中盘默认）：>1%；小盘 >1.5%；大盘 >0.5%（按市值分层）
	•	3 日累计涨幅上限（中盘）：≤5%，小盘 ≤8%，大盘 ≤3%
	•	日换手率中盘范围：2%–8%（分层详见上文）
	•	市值区间：50亿–500亿
	•	股价上限：100 元
	•	评分权重（示例）：fin 0.3 / fund 0.25 / stab 0.25 / price_pos 0.2

⸻

11. 交付物（可选）
	•	一份可执行的 Python 模块（数据拉取 → 筛选 → 打分 → 输出）
	•	一次参数扫描的回测报告（含收益、回撤、权重敏感性）
	•	每日候选股票输出（CSV）与可视化报告（折线 + 分数柱状）

⸻