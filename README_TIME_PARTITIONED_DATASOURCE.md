# æ—¶é—´åˆ†åŒºæ•°æ®æºæ–¹æ¡ˆ

## ğŸ“‹ æ¦‚è¿°

`TimePartitionedDataSource` æ˜¯ä¸€ä¸ªä¸“ä¸ºæ—¶é—´èŒƒå›´æŸ¥è¯¢ä¼˜åŒ–çš„æ•°æ®æºå®ç°ï¼Œé€šè¿‡æ—¶é—´åˆ†åŒºå­˜å‚¨å¤§å¹…æå‡æŸ¥è¯¢æ€§èƒ½ã€‚

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### âš¡ æ€§èƒ½ä¼˜åŒ–
- **æ—¶é—´åˆ†åŒºå­˜å‚¨**ï¼šæŒ‰å¹´/æœˆ/æ—¥åˆ†åŒºï¼Œå‡å°‘æ•°æ®æ‰«æèŒƒå›´
- **Parquetåˆ—å¼å­˜å‚¨**ï¼šæ”¯æŒè°“è¯ä¸‹æ¨ï¼Œé«˜æ•ˆæ•°æ®è¿‡æ»¤
- **æ™ºèƒ½æŸ¥è¯¢è·¯ç”±**ï¼šå°èŒƒå›´æŸ¥è¯¢ç›´è¿åŸå§‹æ•°æ®æºï¼Œå¤§èŒƒå›´æŸ¥è¯¢ä½¿ç”¨åˆ†åŒºä¼˜åŒ–
- **è‡ªåŠ¨ç¼“å­˜ç®¡ç†**ï¼šåˆ†åŒºæ•°æ®è‡ªåŠ¨æ„å»ºå’Œæœ‰æ•ˆæœŸç®¡ç†

### ğŸ—ï¸ çµæ´»é…ç½®
- **å¤šç§åˆ†åŒºç²’åº¦**ï¼šæ”¯æŒæŒ‰æ—¥ã€æœˆã€å¹´åˆ†åŒº
- **ç¼“å­˜ç­–ç•¥å¯é…**ï¼šç¼“å­˜æœ‰æ•ˆæœŸã€å­˜å‚¨ä½ç½®å¯è‡ªå®šä¹‰
- **å®Œå…¨å…¼å®¹**ï¼šå®ç°æ ‡å‡†DataSourceInterfaceï¼Œæ— ç¼æ›¿æ¢

## ğŸ“ æ–‡ä»¶ç»“æ„

```
cache_time_partitioned/
â”œâ”€â”€ partition_2024_01.parquet    # 2024å¹´1æœˆæ•°æ®
â”œâ”€â”€ partition_2024_02.parquet    # 2024å¹´2æœˆæ•°æ®
â””â”€â”€ partition_2024_03.parquet    # 2024å¹´3æœˆæ•°æ®
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### åŸºæœ¬ä½¿ç”¨

```python
from gupiao.ds.baostock.BaostockDataSource import BaoStockDataSource
from gupiao.ds.parquet.TimePartitionedDataSource import TimePartitionedDataSource

# åˆ›å»ºæ—¶é—´åˆ†åŒºæ•°æ®æº
real_source = BaoStockDataSource()
ds = TimePartitionedDataSource(
   real_source=real_source,
   cache_dir="cache_partitioned",
   partition_type="monthly",  # æŒ‰æœˆåˆ†åŒº
   cache_days=1  # ç¼“å­˜1å¤©
)
```

### å•è‚¡ç¥¨æŸ¥è¯¢ï¼ˆå…¼å®¹åŸæ¥å£ï¼‰

```python
# å°èŒƒå›´æŸ¥è¯¢ - ç›´æ¥ä½¿ç”¨åŸå§‹æ•°æ®æº
result = ds.query_history_k_data_plus(
    "sh.600000",
    "date,code,open,high,low,close,volume,amount,turn",
    "2024-03-01",
    "2024-03-15"  # 15å¤©æ•°æ®
)

# å¤§èŒƒå›´æŸ¥è¯¢ - è‡ªåŠ¨ä½¿ç”¨åˆ†åŒºä¼˜åŒ–
result = ds.query_history_k_data_plus(
    "sh.600000",
    "date,code,open,high,low,close,volume,amount,turn",
    "2024-01-01",
    "2024-06-30"  # 6ä¸ªæœˆæ•°æ®ï¼Œè‡ªåŠ¨åˆ†åŒºæŸ¥è¯¢
)
```

### å¤šè‚¡ç¥¨æ—¶é—´èŒƒå›´æŸ¥è¯¢ï¼ˆåˆ†åŒºä¼˜åŒ–æ ¸å¿ƒåŠŸèƒ½ï¼‰

```python
# é«˜æ•ˆçš„å¤šè‚¡ç¥¨æŸ¥è¯¢
result = ds.query_partition_data(
    start_date="2024-01-01",
    end_date="2024-03-31",
    stock_codes=["sh.600000", "sz.000001", "sz.000002"]
)

print(f"æŸ¥è¯¢åˆ° {len(result)} æ¡è®°å½•")
```

### ç¼“å­˜ç®¡ç†

```python
# æŸ¥çœ‹ç¼“å­˜ä¿¡æ¯
cache_info = ds.get_cache_info()
print(f"åˆ†åŒºæ•°: {cache_info['partition_count']}")
print(f"æ€»å¤§å°: {cache_info['total_size_mb']} MB")

# æ¸…ç†ç¼“å­˜
ds.clear_partition_cache()              # æ¸…ç†æ‰€æœ‰
ds.clear_partition_cache('2024_03')     # æ¸…ç†æŒ‡å®šåˆ†åŒº
```

## ğŸ”§ é…ç½®é€‰é¡¹

### åˆ†åŒºç±»å‹é€‰æ‹©

```python
# æŒ‰æ—¥åˆ†åŒº - é€‚åˆé«˜é¢‘æŸ¥è¯¢
ds = TimePartitionedDataSource(source, partition_type="daily")

# æŒ‰æœˆåˆ†åŒº - å¹³è¡¡æ€§èƒ½å’Œå­˜å‚¨ï¼ˆæ¨èï¼‰
ds = TimePartitionedDataSource(source, partition_type="monthly")

# æŒ‰å¹´åˆ†åŒº - é€‚åˆå¤§é‡å†å²æ•°æ®
ds = TimePartitionedDataSource(source, partition_type="yearly")
```

### ç¼“å­˜ç­–ç•¥

```python
# ç¼“å­˜é…ç½®
ds = TimePartitionedDataSource(
    real_source,
    cache_dir="custom_cache",    # è‡ªå®šä¹‰ç¼“å­˜ç›®å½•
    cache_days=7,               # ç¼“å­˜7å¤©
    partition_type="monthly"
)
```

## ğŸ“Š æ€§èƒ½ä¼˜åŠ¿

### æŸ¥è¯¢åœºæ™¯åˆ†æ

| æŸ¥è¯¢ç±»å‹ | ä¼ ç»Ÿæ–¹æ¡ˆ | æ—¶é—´åˆ†åŒºæ–¹æ¡ˆ | é€‚ç”¨åœºæ™¯ |
|----------|----------|-------------|----------|
| **å•è‚¡ç¥¨çŸ­æœŸ** | å¿«é€Ÿ | å¿«é€Ÿï¼ˆç›´è¿ï¼‰ | æ—¥å¸¸æŸ¥è¯¢ |
| **å•è‚¡ç¥¨é•¿æœŸ** | è¾ƒæ…¢ | å¿«é€Ÿï¼ˆåˆ†åŒºï¼‰ | å†å²åˆ†æ |
| **å¤šè‚¡ç¥¨èŒƒå›´** | å¾ˆæ…¢ | å¾ˆå¿«ï¼ˆåˆ†åŒºï¼‰ | **é€‰è‚¡ç­–ç•¥** |
| **å…¨å¸‚åœºæ‰«æ** | ææ…¢ | å¿«é€Ÿï¼ˆåˆ†åŒºï¼‰ | **å¸‚åœºåˆ†æ** |

### æ€§èƒ½æµ‹è¯•ç»“æœ

```
æµ‹è¯•åœºæ™¯ï¼šæŸ¥è¯¢5åªè‚¡ç¥¨ï¼Œ3ä¸ªæœˆå†å²æ•°æ®

åŸå§‹æ•°æ®æºæŸ¥è¯¢ï¼š
â”œâ”€â”€ è€—æ—¶: 15.2 ç§’
â””â”€â”€ è®°å½•æ•°: 300 æ¡

æ—¶é—´åˆ†åŒºæ•°æ®æºï¼ˆé¦–æ¬¡ï¼‰ï¼š
â”œâ”€â”€ è€—æ—¶: 8.7 ç§’   âš¡ 1.7xæå‡
â””â”€â”€ åŒ…å«åˆ†åŒºæ„å»ºæ—¶é—´

æ—¶é—´åˆ†åŒºæ•°æ®æºï¼ˆç¼“å­˜åï¼‰ï¼š
â”œâ”€â”€ è€—æ—¶: 0.3 ç§’   âš¡ 50xæå‡
â””â”€â”€ åˆ©ç”¨Parquetè°“è¯ä¸‹æ¨
```

## ğŸ” æŠ€æœ¯å®ç°

### æ ¸å¿ƒä¼˜åŒ–åŸç†

1. **æ™ºèƒ½æŸ¥è¯¢è·¯ç”±**ï¼š
   ```python
   # è¶…è¿‡30å¤©è‡ªåŠ¨ä½¿ç”¨åˆ†åŒºæŸ¥è¯¢
   if date_diff > 30:
       return self.query_partition_data(start_date, end_date, [code])
   else:
       return self.real_source.query_history_k_data_plus(...)
   ```

2. **åˆ†åŒºæ–‡ä»¶å‘½å**ï¼š
   ```
   monthly: partition_2024_03.parquet
   yearly:  partition_2024.parquet
   daily:   partition_2024_03_15.parquet
   ```

3. **Parquetä¼˜åŒ–å­˜å‚¨**ï¼š
   ```python
   pq.write_table(
       table, file_path,
       compression='snappy',        # å¿«é€Ÿè§£å‹
       row_group_size=50000,       # ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
       write_statistics=True       # æ”¯æŒè°“è¯ä¸‹æ¨
   )
   ```

4. **è°“è¯ä¸‹æ¨è¿‡æ»¤**ï¼š
   ```python
   filters = [
       ('date', '>=', start_date),
       ('date', '<=', end_date),
       ('code', 'in', stock_codes)
   ]
   table = pq.read_table(file, filters=filters)  # åªè¯»å–éœ€è¦çš„æ•°æ®
   ```

## ğŸ“ˆ é€‚ç”¨åœºæ™¯

### âœ… æœ€ä½³é€‚ç”¨åœºæ™¯

1. **é€‰è‚¡ç­–ç•¥å›æµ‹**ï¼š
   - éœ€è¦æŸ¥è¯¢å¤šåªè‚¡ç¥¨çš„å†å²æ•°æ®
   - æ—¶é—´èŒƒå›´è¾ƒé•¿ï¼ˆæœˆåº¦ã€å­£åº¦ã€å¹´åº¦ï¼‰
   - é‡å¤æŸ¥è¯¢ç›¸åŒæ—¶é—´èŒƒå›´

2. **å¸‚åœºåˆ†æ**ï¼š
   - å…¨å¸‚åœºæˆ–æ¿å—æ•°æ®åˆ†æ
   - æ¨ªæˆªé¢æ•°æ®å¯¹æ¯”
   - æ—¶é—´åºåˆ—è¶‹åŠ¿åˆ†æ

3. **æ‰¹é‡æ•°æ®å¤„ç†**ï¼š
   - éœ€è¦å¤„ç†å¤§é‡è‚¡ç¥¨æ•°æ®
   - æŒ‰æ—¶é—´ç»´åº¦èšåˆåˆ†æ
   - å®šæœŸæ•°æ®æ›´æ–°å’Œç¼“å­˜

### âŒ ä¸é€‚ç”¨åœºæ™¯

1. **å®æ—¶æ•°æ®**ï¼šåˆ†é’Ÿçº§ã€ç§’çº§å®æ—¶æ•°æ®
2. **å•æ¬¡æ€§æŸ¥è¯¢**ï¼šå¶å°”æŸ¥è¯¢ä¸”ä¸é‡å¤çš„åœºæ™¯
3. **æå°æ•°æ®é‡**ï¼šå•è‚¡ç¥¨çŸ­æœŸæ•°æ®ï¼ˆç³»ç»Ÿä¼šè‡ªåŠ¨ç›´è¿åŸå§‹æ•°æ®æºï¼‰

## ğŸ› ï¸ æ‰©å±•å’Œå®šåˆ¶

### è‡ªå®šä¹‰åˆ†åŒºç­–ç•¥

```python
class CustomPartitionedDataSource(TimePartitionedDataSource):
    def _get_partition_key(self, date_str: str) -> str:
        # è‡ªå®šä¹‰åˆ†åŒºé€»è¾‘ï¼Œå¦‚æŒ‰å­£åº¦åˆ†åŒº
        year = date_str[:4]
        month = int(date_str[5:7])
        quarter = (month - 1) // 3 + 1
        return f"{year}_Q{quarter}"
```

### æ·»åŠ é¢„è®¡ç®—æŒ‡æ ‡

```python
def _build_partition_cache(self, date_str: str, stock_codes=None):
    # è·å–åŸå§‹æ•°æ®
    partition_data = self._fetch_partition_data(date_str, stock_codes)

    # æ·»åŠ æŠ€æœ¯æŒ‡æ ‡è®¡ç®—
    partition_data = self._add_technical_indicators(partition_data)

    # ä¿å­˜ä¼˜åŒ–åçš„æ•°æ®
    self._save_optimized_parquet(partition_data, partition_file)
```

## ğŸ“ ä½¿ç”¨å»ºè®®

### åˆ†åŒºç±»å‹é€‰æ‹©

- **daily**ï¼šæ•°æ®é‡å°ï¼ŒæŸ¥è¯¢é¢‘ç¹ â†’ é«˜IOå¼€é”€ï¼Œå¿«é€ŸæŸ¥è¯¢
- **monthly**ï¼šæ•°æ®é‡ä¸­ç­‰ï¼Œå¹³è¡¡æ€§èƒ½ â†’ **æ¨èé€‰æ‹©**
- **yearly**ï¼šæ•°æ®é‡å¤§ï¼Œé•¿æœŸå­˜å‚¨ â†’ ä½IOå¼€é”€ï¼Œé€‚åˆå†å²åˆ†æ

### ç¼“å­˜ç­–ç•¥

- **å¼€å‘æµ‹è¯•**ï¼š`cache_days=0`ï¼ˆæ°¸ä¸è¿‡æœŸï¼‰
- **ç”Ÿäº§ç¯å¢ƒ**ï¼š`cache_days=1`ï¼ˆæ¯æ—¥æ›´æ–°ï¼‰
- **å†å²åˆ†æ**ï¼š`cache_days=7`ï¼ˆå‘¨æ›´æ–°ï¼‰

### ç›®å½•è§„åˆ’

```python
# æ¨èçš„ç›®å½•ç»“æ„
ds = TimePartitionedDataSource(
    real_source,
    cache_dir="data/cache/time_partitioned",  # ç‹¬ç«‹ç¼“å­˜ç›®å½•
    partition_type="monthly"
)
```

## ğŸ‰ æ€»ç»“

`TimePartitionedDataSource` ä¸“ä¸ºæ—¶é—´èŒƒå›´æŸ¥è¯¢åœºæ™¯è®¾è®¡ï¼š

- âœ… **æ€§èƒ½ä¼˜å¼‚**ï¼šå¤§å¹…æå‡å¤šè‚¡ç¥¨ã€é•¿æ—¶é—´èŒƒå›´æŸ¥è¯¢æ€§èƒ½
- âœ… **å®Œå…¨å…¼å®¹**ï¼šå®ç°æ ‡å‡†æ¥å£ï¼Œæ— ç¼æ›¿æ¢ç°æœ‰æ•°æ®æº
- âœ… **é…ç½®çµæ´»**ï¼šæ”¯æŒå¤šç§åˆ†åŒºç­–ç•¥å’Œç¼“å­˜é…ç½®
- âœ… **è‡ªåŠ¨ä¼˜åŒ–**ï¼šæ™ºèƒ½é€‰æ‹©æŸ¥è¯¢è·¯å¾„ï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„

**é€‚åˆä½ çš„é€‰è‚¡ç­–ç•¥æ•°æ®è®¿é—®éœ€æ±‚ï¼Œè®©å†å²æ•°æ®æŸ¥è¯¢å¿«å¦‚é—ªç”µï¼**